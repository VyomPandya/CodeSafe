name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

# Set permissions
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate environment variables file
        run: |
          # Ensure public directory exists
          mkdir -p ./public
          
          # Create env-config.js file with proper JSON escaping
          cat > ./public/env-config.js << EOF
          // This file is auto-generated during deployment
          window._env_ = window._env_ || {};
          window._env_.SUPABASE_URL = "${SUPABASE_URL}";
          window._env_.SUPABASE_ANON_KEY = "${SUPABASE_ANON_KEY}";
          window._env_.OPENROUTER_API_KEY = "${OPENROUTER_API_KEY}";
          EOF
          
          # Log file creation (without exposing secrets)
          echo "Created env-config.js in public directory"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Build
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      # Copy 404.html to handle GitHub Pages SPA routing
      - name: Setup routing for SPA
        run: cp dist/index.html dist/404.html

      # Ensure env-config.js is in the dist folder for runtime access
      - name: Ensure env-config.js is in dist folder
        run: |
          cp public/env-config.js dist/
          echo "Copied env-config.js to dist folder"

      # Deploy directly using JamesIves/github-pages-deploy-action
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist # The folder the action should deploy
          branch: gh-pages # The branch the action should deploy to 